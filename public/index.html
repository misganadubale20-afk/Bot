<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Taka Income Pro</title>
    
    <!-- Telegram SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart JS (Optional) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg-body: #F4F6F8;
            --bg-card: #FFFFFF;
            --text-main: #1F2937;
            --text-sub: #6B7280;
            --primary-grad: linear-gradient(135deg, #8B5CF6 0%, #F472B6 100%);
            --primary-color: #8B5CF6;
            --shadow: 0 4px 20px rgba(0,0,0,0.05);
            --radius: 20px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: 'Poppins', sans-serif; background: var(--bg-body); color: var(--text-main); padding-bottom: 90px; }

        /* LOADING SCREEN */
        #loader { 
            position: fixed; inset: 0; background: #fff; z-index: 9999; 
            display: flex; align-items: center; justify-content: center; flex-direction: column;
            transition: opacity 0.5s ease;
        }
        .spinner { width: 45px; height: 45px; border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* HEADER */
        .app-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; background: var(--bg-card); position: sticky; top: 0; z-index: 50; box-shadow: 0 2px 15px rgba(0,0,0,0.03); }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .avatar { width: 45px; height: 45px; border-radius: 50%; background: #eee; border: 2px solid var(--primary-color); display:flex; align-items:center; justify-content:center; overflow:hidden;}
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
        .balance-badge { background: #EEF2FF; color: var(--primary-color); padding: 8px 15px; border-radius: 30px; font-weight: 700; display: flex; align-items: center; gap: 6px; font-size: 15px; }

        /* PAGES */
        .page { display: none; padding: 20px; animation: fadeIn 0.4s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* CARDS */
        .card { background: var(--bg-card); border-radius: var(--radius); padding: 20px; margin-bottom: 15px; box-shadow: var(--shadow); position: relative; overflow: hidden; }
        .card h3 { margin: 0 0 10px 0; font-size: 16px; display: flex; align-items: center; gap: 8px; }
        
        /* BUTTONS */
        .btn-grad { width: 100%; padding: 14px; border: none; border-radius: 15px; background: var(--primary-grad); color: white; font-weight: 600; font-size: 15px; cursor: pointer; box-shadow: 0 5px 15px rgba(139, 92, 246, 0.25); transition: transform 0.1s; }
        .btn-grad:active { transform: scale(0.98); }
        .btn-grad:disabled { background: #ccc; box-shadow: none; opacity: 0.7; }

        .btn-outline { width: 48%; padding: 12px; border: 2px solid var(--primary-color); border-radius: 12px; background: transparent; color: var(--primary-color); font-weight: 600; cursor: pointer; }
        .btn-row { display: flex; justify-content: space-between; margin-top: 15px; }

        /* TASKS */
        .task-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
        .task-item:last-child { border-bottom: none; }
        .task-icon { width: 40px; height: 40px; border-radius: 12px; background: #EEF2FF; color: var(--primary-color); display: flex; align-items: center; justify-content: center; font-size: 18px; margin-right: 12px; }
        .task-title { font-weight: 600; font-size: 14px; color: var(--text-main); }
        .task-reward { font-size: 12px; color: var(--primary-color); font-weight: 700; }
        .task-btn { padding: 6px 14px; border-radius: 20px; border: none; background: #F3F4F6; color: #666; font-size: 12px; font-weight: 600; cursor: pointer; }
        .task-btn.active { background: var(--primary-color); color: white; }

        /* LEADERBOARD */
        .toggle-switch { background: #EEF2FF; padding: 4px; border-radius: 14px; display: flex; margin-bottom: 25px; }
        .toggle-btn { flex: 1; padding: 10px; border: none; border-radius: 12px; background: transparent; color: var(--text-sub); font-weight: 600; cursor: pointer; transition: 0.2s; }
        .toggle-btn.active { background: var(--bg-card); color: var(--primary-color); box-shadow: 0 2px 8px rgba(0,0,0,0.05); }

        .top-3 { display: flex; justify-content: center; align-items: flex-end; gap: 15px; margin-bottom: 30px; }
        .rank-user { text-align: center; position: relative; width: 33%; }
        .rank-avatar { width: 55px; height: 55px; border-radius: 50%; border: 3px solid #FFD700; margin: 0 auto 8px; background: #ddd; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #888; font-size: 20px; }
        .rank-1 .rank-avatar { width: 75px; height: 75px; box-shadow: 0 0 20px rgba(255, 215, 0, 0.3); border-color: #FFD700; }
        .rank-2 .rank-avatar { border-color: #C0C0C0; }
        .rank-3 .rank-avatar { border-color: #CD7F32; }
        .crown { position: absolute; top: -25px; left: 50%; transform: translateX(-50%); font-size: 24px; color: #FFD700; }

        /* NAV BAR */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--bg-card); display: flex; justify-content: space-around; padding: 12px 0 20px 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); border-radius: 25px 25px 0 0; z-index: 100; }
        .nav-link { background: none; border: none; display: flex; flex-direction: column; align-items: center; gap: 5px; color: #9CA3AF; cursor: pointer; transition: 0.2s; width: 20%; }
        .nav-link i { font-size: 22px; transition: 0.2s; }
        .nav-link span { font-size: 10px; font-weight: 500; }
        .nav-link.active { color: var(--primary-color); }
        .nav-link.active i { transform: translateY(-3px); }

        /* INVITE BOX */
        .invite-box { background: #F0F9FF; border: 1px dashed #0EA5E9; padding: 15px; border-radius: 12px; color: #0284C7; font-size: 12px; word-break: break-all; margin: 20px 0; font-family: monospace; }

        /* WITHDRAW STATUS */
        .req-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #F9FAFB; border-radius: 10px; margin-bottom: 8px; }
        .req-status.done { color: #10B981; }
        .req-status.fail { color: #EF4444; }
    </style>
</head>
<body>

    <!-- LOADING SCREEN -->
    <div id="loader">
        <div class="spinner"></div>
        <p style="margin-top:20px; font-weight:500; color:#555;">Starting App...</p>
    </div>

    <!-- HEADER -->
    <div class="app-header">
        <div class="user-info">
            <div class="avatar" id="header-pic"><i class="fa-solid fa-user"></i></div>
            <div>
                <div style="font-weight: 700; font-size: 15px;" id="header-name">Guest</div>
                <div style="font-size: 11px; color: var(--text-sub);">Welcome back</div>
            </div>
        </div>
        <div class="balance-badge">
            <i class="fa-solid fa-coins"></i> <span id="header-balance">0</span>
        </div>
    </div>

    <!-- 1. HOME -->
    <div id="home" class="page active">
        <div class="card">
            <h3 style="color:#EF4444;"><i class="fa-brands fa-youtube"></i> Daily Ads</h3>
            <p>Watch short ads to earn points.</p>
            <button class="btn-grad" id="watch-ad-btn">Watch Ad</button>
        </div>

        <div class="card">
            <h3 style="color:#8B5CF6;"><i class="fa-solid fa-star"></i> Bonus Tasks</h3>
            <div id="bonus-list"></div>
        </div>

        <div class="card">
            <h3><i class="fa-solid fa-chart-line"></i> Activity</h3>
            <canvas id="chart" height="100"></canvas>
        </div>
    </div>

    <!-- 2. TASKS -->
    <div id="tasks" class="page">
        <h2>Tasks</h2>
        <div class="card">
            <div class="task-item">
                <div style="display:flex; align-items:center;">
                    <div class="task-icon"><i class="fa-brands fa-telegram"></i></div>
                    <div class="task-info">
                        <div class="task-title">Join Channel</div>
                        <div class="task-reward">+0.005 USD</div>
                    </div>
                </div>
                <button class="task-btn active" onclick="doTask('join_ch')">Start</button>
            </div>
        </div>
    </div>

    <!-- 3. TOP (LEADERBOARD) -->
    <div id="top" class="page">
        <div class="toggle-switch">
            <button class="toggle-btn active" onclick="switchTab(this)">By Points</button>
            <button class="toggle-btn" onclick="switchTab(this)">By Invite</button>
        </div>
        
        <div class="top-3">
            <div class="rank-user rank-2">
                <div class="rank-avatar">2</div>
                <div style="font-size:12px; font-weight:bold;">Alex</div>
                <div style="font-size:10px;">500 pts</div>
            </div>
            <div class="rank-user rank-1">
                <div class="crown"><i class="fa-solid fa-crown"></i></div>
                <div class="rank-avatar">1</div>
                <div style="font-size:12px; font-weight:bold;">Sarah</div>
                <div style="font-size:10px;">1200 pts</div>
            </div>
            <div class="rank-user rank-3">
                <div class="rank-avatar">3</div>
                <div style="font-size:12px; font-weight:bold;">John</div>
                <div style="font-size:10px;">300 pts</div>
            </div>
        </div>

        <div class="card" style="padding:10px;">
            <div class="task-item">
                <span style="width:30px; font-weight:bold; text-align:center;">4</span>
                <div class="task-info" style="margin-left:10px;">User 992</div>
                <span style="font-weight:bold; color:var(--primary-color);">150 pts</span>
            </div>
            <div class="task-item">
                <span style="width:30px; font-weight:bold; text-align:center;">5</span>
                <div class="task-info" style="margin-left:10px;">User 101</div>
                <span style="font-weight:bold; color:var(--primary-color);">90 pts</span>
            </div>
        </div>
    </div>

    <!-- 4. INVITE -->
    <div id="invite" class="page">
        <div class="card" style="text-align:center;">
            <i class="fa-solid fa-gift" style="font-size:50px; color:#F472B6; margin-bottom:15px;"></i>
            <h2>Invite & Earn</h2>
            <p>Get <b style="color:var(--primary-color);">$0.01</b> for each friend.</p>
            
            <div class="invite-box" id="ref-link-box">Loading...</div>
            
            <div class="btn-row">
                <button class="btn-grad" style="width:48%" onclick="copyRef()">Copy</button>
                <button class="btn-outline" style="width:48%" onclick="shareRef()">Share</button>
            </div>
        </div>
        <h3>My Invites (<span id="total-refs">0</span>)</h3>
        <div class="card" style="text-align:center; padding:30px; color:#aaa;">No invites yet</div>
    </div>

    <!-- 5. PAY (WITHDRAW) -->
    <div id="pay" class="page">
        <h2>Withdrawal</h2>
        <div class="card">
            <h3>Requirements</h3>
            <div class="req-item">
                <span>Invites (<span id="req-inv">0</span>/2)</span>
                <i class="fa-solid fa-xmark req-status fail" id="icon-inv"></i>
            </div>
            <div class="req-item">
                <span>Ads Watched (<span id="req-ads">0</span>/10)</span>
                <i class="fa-solid fa-xmark req-status fail" id="icon-ads"></i>
            </div>
            <div class="req-item">
                <span>Bonus Tasks (1/2)</span>
                <i class="fa-solid fa-check req-status done"></i>
            </div>
            <button class="btn-grad" id="unlock-btn" disabled style="background:#ddd; margin-top:10px;">Locked</button>
        </div>

        <div class="card" id="withdraw-form" style="display:none;">
            <h3>Request Payment</h3>
            <select id="w-method" style="width:100%; padding:12px; margin:10px 0; border:1px solid #ddd; border-radius:10px;">
                <option>Binance UID</option>
                <option>Bikash</option>
                <option>Nogad</option>
            </select>
            <input id="w-account" placeholder="Enter Wallet/ID" style="width:100%; padding:12px; margin:10px 0; border:1px solid #ddd; border-radius:10px;">
            <input id="w-amount" type="number" placeholder="Amount (USD)" style="width:100%; padding:12px; margin:10px 0; border:1px solid #ddd; border-radius:10px;">
            <button class="btn-grad" onclick="submitWithdraw()">Submit Request</button>
        </div>
    </div>

    <!-- BOTTOM NAV -->
    <nav class="bottom-nav">
        <button class="nav-link active" onclick="nav('home', this)"><i class="fa-solid fa-house"></i><span>Home</span></button>
        <button class="nav-link" onclick="nav('tasks', this)"><i class="fa-solid fa-list-check"></i><span>Tasks</span></button>
        <button class="nav-link" onclick="nav('top', this)"><i class="fa-solid fa-trophy"></i><span>Top</span></button>
        <button class="nav-link" onclick="nav('invite', this)"><i class="fa-solid fa-user-plus"></i><span>Invite</span></button>
        <button class="nav-link" onclick="nav('pay', this)"><i class="fa-solid fa-wallet"></i><span>Pay</span></button>
    </nav>

    <script>
        // --- CONFIGURATION ---
        const CONFIG = {
            DB_URL: "https://data-myfa.vercel.app/api/db/bot",
            DB_KEY: "QLE3KvEiqW29j269",
            BOT_USERNAME: "Yichuwatchrobot",
            MIN_INVITE: 2,
            MIN_ADS: 10
        };

        const tg = window.Telegram.WebApp;
        tg.expand(); 

        const user = tg.initDataUnsafe.user || { id: "12345", first_name: "Guest", photo_url: "" };
        const userId = user.id.toString();

        let state = { balance: 0, ads: 0, refs: 0, bonus: [] };
        let settings = { adReward: 0.001, zoneId: "" };

        // --- APP LOGIC ---
        function nav(page, btn) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(page).classList.add('active');
            document.querySelectorAll('.nav-link').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            if(page === 'pay') checkRequirements();
        }

        function switchTab(btn) {
            document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        async function init() {
            // Force Remove Loader after 3s (The FIX)
            setTimeout(() => document.getElementById('loader').style.opacity = '0', 2500);
            setTimeout(() => document.getElementById('loader').style.display = 'none', 3000);

            // Render Basic Info immediately
            document.getElementById('header-name').innerText = user.first_name;
            if(user.photo_url) document.getElementById('header-pic').innerHTML = `<img src="${user.photo_url}">`;
            document.getElementById('ref-link-box').innerText = `https://t.me/${CONFIG.BOT_USERNAME}?start=${userId}`;

            try {
                // Fetch Settings
                let sRes = await fetch(`${CONFIG.DB_URL}/config/settings`, {headers:{"x-secret-key":CONFIG.DB_KEY}});
                if(sRes.ok) {
                    let s = await sRes.json();
                    settings.adReward = parseFloat(s.adReward || 0.001);
                    settings.zoneId = s.adZoneId;
                    if(settings.zoneId) loadMonetag(settings.zoneId);
                }

                // Fetch User
                let uRes = await fetch(`${CONFIG.DB_URL}/users/${userId}`, {headers:{"x-secret-key":CONFIG.DB_KEY}});
                if(uRes.ok) {
                    let d = await uRes.json();
                    if(d.id) {
                        state.balance = d.balance || 0;
                        state.ads = d.adCount || d.adsWatched || 0;
                        state.refs = d.referrals || 0;
                        state.bonus = d.bonusTasks || [];
                    }
                } else {
                    // Create User if new
                    fetch(`${CONFIG.DB_URL}/users/${userId}`, {
                        method: 'POST',
                        headers: {'Content-Type':'application/json', "x-secret-key":CONFIG.DB_KEY},
                        body: JSON.stringify({id:userId, firstName:user.first_name, balance:0, adCount:0, referrals:0})
                    });
                }
            } catch(e) { console.log("Init Error (Ignored for UI safety):", e); }

            updateUI();
            renderBonus();
            drawChart();
        }

        function updateUI() {
            document.getElementById('header-balance').innerText = state.balance.toFixed(3);
            document.getElementById('total-refs').innerText = state.refs;
            document.getElementById('watch-ad-btn').innerText = `Watch Ad (+${settings.adReward})`;
            
            // Requirements
            document.getElementById('req-inv').innerText = state.refs;
            document.getElementById('req-ads').innerText = state.ads;
        }

        // --- ADS ---
        function loadMonetag(zone) {
            const s = document.createElement('script');
            s.src = "//libtl.com/sdk.js";
            s.dataset.zone = zone;
            s.dataset.sdk = `show_${zone}`;
            document.body.appendChild(s);
        }

        document.getElementById('watch-ad-btn').onclick = () => {
            const showAd = window[`show_${settings.zoneId}`];
            if(typeof showAd === 'function') {
                showAd().then(() => {
                    state.balance += settings.adReward;
                    state.ads++;
                    saveData();
                    updateUI();
                    tg.showAlert("Success! Points Added.");
                });
            } else {
                tg.showAlert("Ad loading... please wait.");
            }
        };

        // --- TASKS ---
        const bonusTasks = [
            { id: 't1', title: 'Join Channel', reward: 0.005, link: 'https://t.me/BasicTouchPro' },
            { id: 't2', title: 'Follow Owner', reward: 0.002, link: 'https://t.me/BasicTouch' }
        ];

        function renderBonus() {
            const list = document.getElementById('bonus-list');
            list.innerHTML = '';
            bonusTasks.forEach(t => {
                const isDone = state.bonus.includes(t.id);
                list.innerHTML += `
                <div class="task-item">
                    <div class="task-icon"><i class="fa-solid fa-star"></i></div>
                    <div class="task-info">
                        <div class="task-title">${t.title}</div>
                        <div class="task-reward">+${t.reward}</div>
                    </div>
                    <button class="task-btn ${isDone?'':'active'}" onclick="doTask('${t.id}')" ${isDone?'disabled':''}>
                        ${isDone?'Done':'Do'}
                    </button>
                </div>`;
            });
        }

        window.doTask = (tid) => {
            const t = bonusTasks.find(x => x.id === tid) || { link: 'https://t.me/BasicTouchPro', reward: 0.005 };
            tg.openTelegramLink(t.link);
            setTimeout(() => {
                if(!state.bonus.includes(tid)) {
                    state.balance += t.reward;
                    state.bonus.push(tid);
                    saveData();
                    updateUI();
                    renderBonus();
                }
            }, 5000);
        }

        // --- WITHDRAW LOGIC ---
        function checkRequirements() {
            const invDone = state.refs >= CONFIG.MIN_INVITE;
            const adsDone = state.ads >= CONFIG.MIN_ADS;
            
            document.getElementById('icon-inv').className = invDone ? 'fa-solid fa-check req-status done' : 'fa-solid fa-xmark req-status fail';
            document.getElementById('icon-ads').className = adsDone ? 'fa-solid fa-check req-status done' : 'fa-solid fa-xmark req-status fail';

            if(invDone && adsDone) {
                document.getElementById('unlock-btn').style.display = 'none';
                document.getElementById('withdraw-form').style.display = 'block';
            }
        }

        window.submitWithdraw = async () => {
            const amt = parseFloat(document.getElementById('w-amount').value);
            if(amt > state.balance) return tg.showAlert("Insufficient Balance");
            if(amt < 0.10) return tg.showAlert("Minimum $0.10");

            state.balance -= amt;
            saveData();
            updateUI();

            await fetch('/api/bot', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({
                    action: 'withdraw',
                    userId, name: user.first_name,
                    amount: amt,
                    method: document.getElementById('w-method').value,
                    account: document.getElementById('w-account').value
                })
            });
            tg.showAlert("Request Sent!");
        };

        // --- HELPERS ---
        async function saveData() {
            fetch(`${CONFIG.DB_URL}/users/${userId}`, {
                method: 'POST',
                headers: {'Content-Type':'application/json', "x-secret-key":CONFIG.DB_KEY},
                body: JSON.stringify({
                    id: userId,
                    firstName: user.first_name,
                    balance: state.balance,
                    adCount: state.ads,
                    referrals: state.refs,
                    bonusTasks: state.bonus
                })
            });
        }

        window.copyRef = () => {
            navigator.clipboard.writeText(`https://t.me/${CONFIG.BOT_USERNAME}?start=${userId}`);
            tg.showAlert("Copied!");
        };
        window.shareRef = () => {
            tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(`https://t.me/${CONFIG.BOT_USERNAME}?start=${userId}`)}`);
        };

        function drawChart() {
            // Optional: Only draws if Chart.js loaded
            if(typeof Chart === 'undefined') return;
            new Chart(document.getElementById('chart'), {
                type: 'line',
                data: {
                    labels: ['M', 'T', 'W', 'T', 'F', 'S', 'S'],
                    datasets: [{
                        label: 'Earnings',
                        data: [0, 0.01, 0.03, 0.02, 0.05, 0.04, 0.01],
                        borderColor: '#8B5CF6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { plugins: {legend:false}, scales: {x:{display:false}, y:{display:false}} }
            });
        }

        // START
        window.onload = init;
    </script>
</body>
</html>