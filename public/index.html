<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Taka Income Pro</title>

    <!-- Telegram SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700;800&display=swap');
        :root { --primary: #007AFF; --bg: #F0F2F5; --card: #FFFFFF; --text: #1D1D1F; }
        [data-theme="dark"] { --primary: #0A84FF; --bg: #000000; --card: #1C1C1E; --text: #F5F5F7; }
        
        body { font-family: 'Noto Sans', sans-serif; margin: 0; padding: 15px; background: var(--bg); color: var(--text); padding-bottom: 80px; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        /* PRELOADER */
        #preloader { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .loader-spin { font-size: 40px; color: var(--primary); animation: spin 1s infinite linear; margin-bottom: 15px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* UI ELEMENTS */
        .container { max-width: 500px; margin: 0 auto; display: none; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

        .header { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
        .avatar { width: 45px; height: 45px; background: #ccc; border-radius: 50%; overflow: hidden; display:flex; align-items:center; justify-content:center; font-size:20px;}
        .avatar img { width: 100%; height: 100%; object-fit: cover; }

        .balance-card { background: linear-gradient(135deg, var(--primary), #0056B3); color: white; padding: 25px; border-radius: 20px; text-align: center; margin-bottom: 15px; box-shadow: 0 10px 20px rgba(0,122,255,0.3); }
        .balance-amount { font-size: 38px; font-weight: 800; margin-top: 5px; }

        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-box { background: var(--card); padding: 15px; border-radius: 15px; text-align: center; }
        .stat-val { font-size: 20px; font-weight: 700; }
        .stat-label { font-size: 12px; opacity: 0.7; }

        .btn { width: 100%; padding: 15px; border: none; border-radius: 12px; background: var(--primary); color: white; font-weight: 600; font-size: 16px; margin-bottom: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn:active { transform: scale(0.98); }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }

        /* NAVBAR */
        .nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--card); padding: 10px; display: flex; justify-content: space-around; border-top: 1px solid #ccc; z-index: 100; }
        .nav-item { border: none; background: none; color: var(--text); opacity: 0.6; font-size: 10px; display: flex; flex-direction: column; align-items: center; }
        .nav-item i { font-size: 20px; margin-bottom: 3px; }
        .nav-item.active { opacity: 1; color: var(--primary); }

        /* MODAL */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: flex-end; }
        .modal-content { background: var(--card); width: 100%; border-radius: 20px 20px 0 0; padding: 25px; animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform:translateY(100%); } to { transform:translateY(0); } }
        input, select { width: 100%; padding: 12px; margin: 10px 0; background: var(--bg); border: 1px solid #ccc; border-radius: 10px; color: var(--text); }
        
        #ad-loader { position: fixed; inset: 0; background: rgba(0,0,0,0.9); color: white; z-index: 5000; display: none; align-items: center; justify-content: center; flex-direction: column; }
    </style>
</head>
<body>

    <!-- LOADING SCREEN -->
    <div id="preloader">
        <i class="fa-solid fa-spinner loader-spin"></i>
        <div id="loading-text" style="font-weight: bold;">Loading... 0%</div>
    </div>

    <!-- AD LOADER -->
    <div id="ad-loader">
        <i class="fa-solid fa-circle-notch loader-spin"></i>
        <div>Loading Advertisement...</div>
    </div>

    <!-- MAIN APP -->
    <div class="container">
        <div class="header">
            <div class="avatar" id="avatar"></div>
            <div>
                <div style="font-size: 18px; font-weight: 700;" id="username">Guest</div>
                <div style="font-size: 12px; opacity: 0.7;" id="userid">ID: ...</div>
            </div>
        </div>

        <div class="balance-card">
            <div>Total Balance</div>
            <div class="balance-amount" id="balance">$0.000</div>
        </div>

        <div class="stats">
            <div class="stat-box">
                <div class="stat-val" id="ads-count">0</div>
                <div class="stat-label">Ads Watched</div>
            </div>
            <div class="stat-box">
                <div class="stat-val" id="ref-count">0</div>
                <div class="stat-label">Referrals</div>
            </div>
        </div>

        <button class="btn" id="watch-btn"><i class="fa-solid fa-play"></i> Watch Ad ($0.001)</button>
        <button class="btn btn-outline" onclick="openLink('https://t.me/BasicTouchPro')"><i class="fa-brands fa-telegram"></i> Join Channel</button>
        
        <div style="margin-top: 20px;">
            <h3>Weekly Stats</h3>
            <canvas id="chart" height="150"></canvas>
        </div>
    </div>

    <!-- NAVIGATION -->
    <div class="nav">
        <button class="nav-item active" onclick="closeModals()"><i class="fa-solid fa-home"></i> Home</button>
        <button class="nav-item" onclick="openModal('withdraw')"><i class="fa-solid fa-wallet"></i> Withdraw</button>
        <button class="nav-item" onclick="openModal('invite')"><i class="fa-solid fa-users"></i> Invite</button>
    </div>

    <!-- WITHDRAW MODAL -->
    <div id="modal-withdraw" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3>Withdraw</h3>
                <i class="fa-solid fa-xmark" onclick="closeModals()" style="font-size: 24px;"></i>
            </div>
            <p>Min Withdraw: <b>$0.10</b></p>
            <form id="withdraw-form">
                <select id="w-method">
                    <option>Binance UID</option>
                    <option>Bikash</option>
                    <option>Nogad</option>
                </select>
                <input id="w-account" placeholder="Wallet / Number" required>
                <input type="number" id="w-amount" placeholder="Amount (USD)" step="0.001" required>
                <button type="submit" class="btn">Confirm Request</button>
            </form>
        </div>
    </div>

    <!-- INVITE MODAL -->
    <div id="modal-invite" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3>Invite Friends</h3>
                <i class="fa-solid fa-xmark" onclick="closeModals()" style="font-size: 24px;"></i>
            </div>
            <p align="center">Earn <b>$0.01</b> per referral!</p>
            <input id="ref-link" readonly onclick="copyRef()">
            <button class="btn" onclick="copyRef()">Copy Link</button>
        </div>
    </div>

    <script>
        // ===================================
        // ⚙️ CONFIGURATION
        // ===================================
        const CONFIG = {
            DB_URL: "https://data-myfa.vercel.app/api/db/bot",
            DB_KEY: "QLE3KvEiqW29j269",
            BOT_USERNAME: "BasicTouchProBot", // No @
            MONETAG_ZONE: "YOUR_MONETAG_ZONE_ID_HERE", 
            MIN_WITHDRAW: 0.10,
            AD_REWARD: 0.001
        };

        // --- INIT ---
        const tg = window.Telegram.WebApp;
        tg.expand(); 

        const user = tg.initDataUnsafe.user || { id: "12345", first_name: "Guest", username: "guest" };
        const userId = user.id.toString();

        let state = { id: userId, balance: 0, ads: 0, refs: 0 };

        // DOM Elements
        const el = {
            preloader: document.getElementById('preloader'),
            container: document.querySelector('.container'),
            balance: document.getElementById('balance'),
            ads: document.getElementById('ads-count'),
            refs: document.getElementById('ref-count'),
            loadingText: document.getElementById('loading-text')
        };

        // --- FUNCTIONS ---

        async function init() {
            // Setup Profile
            document.getElementById('username').innerText = user.first_name;
            document.getElementById('userid').innerText = "ID: " + userId;
            document.getElementById('ref-link').value = `https://t.me/${CONFIG.BOT_USERNAME}?start=${userId}`;
            if(user.photo_url) document.getElementById('avatar').innerHTML = `<img src="${user.photo_url}">`;
            else document.getElementById('avatar').innerText = user.first_name.charAt(0);

            // Load Monetag
            const s = document.createElement('script');
            s.src = "//libtl.com/sdk.js";
            s.dataset.zone = CONFIG.MONETAG_ZONE;
            s.dataset.sdk = `show_${CONFIG.MONETAG_ZONE}`;
            document.head.appendChild(s);

            // Fetch Data
            try {
                const res = await fetch(`${CONFIG.DB_URL}/users/${userId}`, {
                    headers: { "x-secret-key": CONFIG.DB_KEY }
                });
                if(res.ok) {
                    const data = await res.json();
                    if(data.id) state = { ...state, ...data };
                } else {
                    saveData(); // Create new
                }
            } catch(e) { console.error(e); }

            updateUI();
            
            // Hide Loader
            el.preloader.style.opacity = '0';
            setTimeout(() => {
                el.preloader.style.display = 'none';
                el.container.style.display = 'block';
            }, 500);
        }

        async function saveData() {
            await fetch(`${CONFIG.DB_URL}/users/${userId}`, {
                method: "POST",
                headers: { "Content-Type": "application/json", "x-secret-key": CONFIG.DB_KEY },
                body: JSON.stringify({
                    id: userId,
                    firstName: user.first_name,
                    balance: state.balance,
                    adsWatched: state.ads,
                    referrals: state.refs
                })
            });
        }

        function updateUI() {
            el.balance.innerText = `$${state.balance.toFixed(3)}`;
            el.ads.innerText = state.ads;
            el.refs.innerText = state.refs;
        }

        // --- EVENTS ---

        // Watch Ad
        document.getElementById('watch-btn').onclick = () => {
            const showAd = window[`show_${CONFIG.MONETAG_ZONE}`];
            if(typeof showAd === 'function') {
                document.getElementById('ad-loader').style.display = 'flex';
                showAd().then(() => {
                    state.balance += CONFIG.AD_REWARD;
                    state.ads++;
                    updateUI();
                    saveData();
                    tg.showAlert(`Success! +$${CONFIG.AD_REWARD}`);
                }).catch(() => tg.showAlert("Ad failed to load"))
                .finally(() => document.getElementById('ad-loader').style.display = 'none');
            } else {
                tg.showAlert("Ads loading... wait 5 seconds");
            }
        };

        // Withdraw
        document.getElementById('withdraw-form').onsubmit = async (e) => {
            e.preventDefault();
            const amt = parseFloat(document.getElementById('w-amount').value);
            const mth = document.getElementById('w-method').value;
            const acc = document.getElementById('w-account').value;

            if(amt < CONFIG.MIN_WITHDRAW) return tg.showAlert(`Min: $${CONFIG.MIN_WITHDRAW}`);
            if(amt > state.balance) return tg.showAlert("Insufficient Balance");

            state.balance -= amt;
            updateUI();
            saveData();

            // Send to Vercel Backend
            fetch('/api/bot', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({
                    action: 'withdraw',
                    userId: userId,
                    userDetails: user.first_name,
                    amount: amt,
                    method: mth,
                    account: acc
                })
            });

            closeModals();
            tg.showAlert("Request Sent!");
        };

        // UI Helpers
        window.openModal = (id) => document.getElementById('modal-'+id).style.display = 'flex';
        window.closeModals = () => document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
        window.copyRef = () => {
            navigator.clipboard.writeText(document.getElementById('ref-link').value);
            tg.showAlert("Copied!");
        };
        window.openLink = (url) => tg.openTelegramLink(url);

        // Failsafe Loader (Forces open after 3s)
        let percent = 0;
        const loadInt = setInterval(() => {
            percent += 5;
            if(percent > 90) clearInterval(loadInt);
            el.loadingText.innerText = `Loading... ${percent}%`;
        }, 100);

        setTimeout(() => {
            if(el.preloader.style.display !== 'none') init();
        }, 3000);

        window.onload = init;

    </script>
</body>
</html>