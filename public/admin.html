<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Besh Super Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #5856D6;
            --bg-body: #F3F4F6;
            --bg-sidebar: #5856D6;
            --card-bg: #FFFFFF;
            --text-main: #1F2937;
        }

        * { box-sizing: border-box; outline: none; }
        body { margin: 0; font-family: 'Poppins', sans-serif; background: var(--bg-body); display: flex; height: 100vh; overflow: hidden; }

        /* --- 1. COMPACT SIDEBAR (Icons Only) --- */
        .sidebar {
            width: 70px; /* Fixed narrow width */
            background: var(--bg-sidebar);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
            flex-shrink: 0;
            z-index: 100;
        }

        .nav-item {
            width: 50px;
            height: 50px;
            margin-bottom: 15px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255,255,255,0.6);
            transition: 0.3s;
            font-size: 20px;
        }

        .nav-item:hover, .nav-item.active {
            background: rgba(255,255,255,0.2);
            color: #fff;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        /* Tooltip for icons */
        .nav-item { position: relative; }
        .nav-item::after {
            content: attr(data-title);
            position: absolute;
            left: 60px;
            background: #333;
            color: #fff;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: 0.2s;
            z-index: 200;
        }
        .nav-item:hover::after { opacity: 1; left: 65px; }

        /* --- MAIN CONTENT --- */
        .main-content { flex: 1; padding: 20px; overflow-y: auto; position: relative; }
        
        .header-title { font-size: 24px; font-weight: 700; margin-bottom: 20px; color: var(--text-main); }

        /* CARDS */
        .card { background: var(--card-bg); padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.03); margin-bottom: 20px; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(5px)} to{opacity:1;transform:translateY(0)} }

        /* STATS GRID */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; }
        .stat-card { background: #F9FAFB; padding: 15px; border-radius: 12px; text-align: center; border: 1px solid #E5E7EB; }
        .stat-val { font-size: 20px; font-weight: 700; color: var(--primary); margin-top: 5px; }
        .stat-label { font-size: 12px; color: #6B7280; }

        /* INPUTS */
        input, textarea, select { width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; margin-top: 5px; margin-bottom: 15px; font-family: inherit; }
        label { font-size: 12px; font-weight: 600; color: #4B5563; }

        /* BUTTONS */
        .btn { padding: 12px; width: 100%; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; color: white; background: var(--primary); transition: 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-green { background: #10B981; }
        .btn-red { background: #EF4444; }

        /* LIST ITEMS */
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #F3F4F6; border-radius: 8px; margin-bottom: 8px; font-size: 13px; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; }
        .badge.pending { background: #FEF3C7; color: #D97706; }

        /* SECTIONS */
        .section { display: none; }
        .section.active { display: block; }
        
        /* AUTH OVERLAY */
        #auth-overlay { position: fixed; inset: 0; background: #F3F4F6; z-index: 1000; display: flex; align-items: center; justify-content: center; }
        .auth-card { background: white; padding: 30px; border-radius: 20px; width: 300px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

    <!-- LOGIN SCREEN -->
    <div id="auth-overlay">
        <div class="auth-card">
            <h2 style="margin-top:0; color:var(--primary);">Admin Login</h2>
            <input type="password" id="password" placeholder="Enter Password (123)">
            <button class="btn" onclick="login()">Access Panel</button>
        </div>
    </div>

    <!-- COMPACT SIDEBAR -->
    <div class="sidebar">
        <div class="nav-item active" data-title="Dashboard" onclick="nav('dashboard', this)">
            <i class="fa-solid fa-chart-pie"></i>
        </div>
        <div class="nav-item" data-title="Configuration" onclick="nav('config', this)">
            <i class="fa-solid fa-sliders"></i>
        </div>
        <div class="nav-item" data-title="Tasks" onclick="nav('tasks', this)">
            <i class="fa-solid fa-list-check"></i>
        </div>
        <div class="nav-item" data-title="Withdrawals" onclick="nav('withdrawals', this)">
            <i class="fa-solid fa-money-check-dollar"></i>
        </div>
        <div class="nav-item" data-title="Broadcast" onclick="nav('broadcast', this)">
            <i class="fa-solid fa-bullhorn"></i>
        </div>
    </div>

    <!-- CONTENT -->
    <div class="main-content">
        
        <!-- 1. DASHBOARD -->
        <div id="dashboard" class="section active">
            <div class="header-title">Dashboard</div>
            <div class="card">
                <h3>Real-Time Overview</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Users</div>
                        <div class="stat-val" id="st-users">...</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Pending Requests</div>
                        <div class="stat-val" id="st-pending">...</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Paid ($)</div>
                        <div class="stat-val" id="st-paid">...</div>
                    </div>
                </div>
                <button class="btn" style="margin-top:20px; background:#1F2937;" onclick="loadRealData()">ðŸ”„ Refresh Data</button>
            </div>
        </div>

        <!-- 2. CONFIGURATION -->
        <div id="config" class="section">
            <div class="header-title">Settings</div>
            <div class="card">
                <label>Welcome Message</label>
                <textarea id="welcomeText" rows="3"></textarea>

                <label>Welcome Image URL</label>
                <input id="welcomeImg">

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                    <div>
                        <label>Ad Reward ($)</label>
                        <input id="adReward" type="number" step="0.001">
                    </div>
                    <div>
                        <label>Min Withdraw ($)</label>
                        <input id="minWithdraw" type="number" step="0.01">
                    </div>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                    <div>
                        <label>Ref Bonus ($)</label>
                        <input id="refBonus" type="number" step="0.001">
                    </div>
                    <div>
                        <label>Daily Ad Limit</label>
                        <input id="dailyLimit" type="number">
                    </div>
                </div>

                <label>Channel Link</label>
                <input id="botLink">

                <button class="btn btn-green" onclick="saveSettings()">ðŸ’¾ Save Changes</button>
            </div>
        </div>

        <!-- 3. TASKS -->
        <div id="tasks" class="section">
            <div class="header-title">Task Manager</div>
            <div class="card">
                <h3>Add New Task</h3>
                <input id="t-title" placeholder="Title (e.g. Join Channel)">
                <input id="t-reward" type="number" placeholder="Reward (e.g. 0.05)">
                <input id="t-link" placeholder="https://t.me/...">
                <button class="btn" onclick="addTask()">Add Task</button>
            </div>
            <div class="card">
                <h3>Active Tasks</h3>
                <div id="task-list">Loading...</div>
            </div>
        </div>

        <!-- 4. WITHDRAWALS -->
        <div id="withdrawals" class="section">
            <div class="header-title">Withdrawals</div>
            <div class="card">
                <button class="btn" onclick="loadWithdrawals()">ðŸ”„ Load Pending Requests</button>
                <div id="w-list" style="margin-top:15px;"></div>
            </div>
        </div>

        <!-- 5. BROADCAST -->
        <div id="broadcast" class="section">
            <div class="header-title">Broadcast</div>
            <div class="card">
                <label>Message</label>
                <textarea id="bc-msg" rows="4"></textarea>
                <label>Image URL (Optional)</label>
                <input id="bc-img">
                <button class="btn btn-green" onclick="sendBroadcast()">ðŸš€ Send to All Users</button>
            </div>
        </div>

    </div>

    <script>
        const API = '/api/bot';
        let PASS = "";

        // UI Logic
        function nav(id, el) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
        }

        // --- AUTH & DATA ---
        async function login() {
            PASS = document.getElementById('password').value;
            const res = await fetch(API, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action: 'admin_action', type: 'get_settings', password: PASS })
            });

            if(res.ok) {
                const data = await res.json();
                if(data.error) return alert("Wrong Password");
                
                document.getElementById('auth-overlay').style.display = 'none';
                populateConfig(data);
                loadRealData();
            } else {
                alert("Server Error");
            }
        }

        // --- 1. LOAD REAL DATA ---
        async function loadRealData() {
            const res = await fetch(API, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action: 'admin_action', type: 'get_stats', password: PASS })
            });
            const d = await res.json();
            
            document.getElementById('st-users').innerText = d.totalUsers || 0;
            document.getElementById('st-pending').innerText = d.pendingWithdrawals || 0;
            document.getElementById('st-paid').innerText = (d.totalPaid || 0).toFixed(2);
        }

        // --- 2. CONFIGURATION ---
        function populateConfig(data) {
            const fields = ['welcomeText', 'welcomeImg', 'adReward', 'minWithdraw', 'refBonus', 'botLink'];
            fields.forEach(f => {
                if(document.getElementById(f)) document.getElementById(f).value = data[f] || '';
            });
        }

        async function saveSettings() {
            const data = {
                welcomeText: document.getElementById('welcomeText').value,
                welcomeImg: document.getElementById('welcomeImg').value,
                adReward: document.getElementById('adReward').value,
                minWithdraw: document.getElementById('minWithdraw').value,
                refBonus: document.getElementById('refBonus').value,
                botLink: document.getElementById('botLink').value,
            };
            await apiCall('save_settings', { data });
            alert("Settings Saved!");
        }

        // --- 3. TASKS ---
        async function addTask() {
            const task = {
                id: Date.now().toString(),
                title: document.getElementById('t-title').value,
                reward: document.getElementById('t-reward').value,
                link: document.getElementById('t-link').value
            };
            await apiCall('add_task', { task });
            alert("Task Added!");
            loadTasks(); // Refresh list
        }

        // --- 4. WITHDRAWALS ---
        async function loadWithdrawals() {
            const res = await apiCall('get_withdrawals');
            const list = document.getElementById('w-list');
            list.innerHTML = "";
            
            if(!res.withdrawals || res.withdrawals.length === 0) {
                list.innerHTML = "<p style='text-align:center; color:#888;'>No pending requests.</p>";
                return;
            }

            res.withdrawals.forEach(w => {
                list.innerHTML += `
                <div class="list-item">
                    <div>
                        <b>${w.method}</b> - ${w.amount}$<br>
                        <small>${w.account}</small><br>
                        <small>ID: ${w.userId}</small>
                    </div>
                    <div>
                        <button class="badge pending" onclick="pay('${w.userId}', ${w.amount})">Pay</button>
                    </div>
                </div>`;
            });
        }

        async function pay(uid, amt) {
            if(!confirm("Mark as Paid?")) return;
            await apiCall('approve_withdraw', { userId: uid, amount: amt });
            alert("Marked as Paid!");
            loadWithdrawals();
        }

        // --- 5. BROADCAST ---
        async function sendBroadcast() {
            if(!confirm("Send to EVERYONE?")) return;
            const res = await apiCall('broadcast', {
                message: document.getElementById('bc-msg').value,
                image: document.getElementById('bc-img').value
            });
            alert(`Sent to ${res.sent} users`);
        }

        // Helper
        async function apiCall(type, payload = {}) {
            const res = await fetch(API, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action: 'admin_action', type, password: PASS, ...payload })
            });
            return await res.json();
        }
    </script>
</body>
</html>